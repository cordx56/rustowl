name: NeoVim Checks
on:
  pull_request:
    paths:
      - lua/**/*
      - ftplugin/**/*
      - .luacheckrc
      - .stylua.toml
      - selene.toml
      - vim.yml
      - nvim-tests/**/*
      - crates/xtask/**/*
      - .github/workflows/neovim-checks.yml
  push:
    branches:
      - main
    paths:
      - lua/**/*
      - ftplugin/**/*
      - .luacheckrc
      - .stylua.toml
      - selene.toml
      - vim.yml
      - nvim-tests/**/*
      - crates/xtask/**/*
      - .github/workflows/neovim-checks.yml
permissions:
  contents: read
env:
  CARGO_TERM_COLOR: always
jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Setup Neovim
        uses: rhysd/action-setup-vim@19e3dd31a84dbc2c5445d65e9b363f616cab96c1 # v1.6.0
        with:
          neovim: true
          version: v0.11.2
      - name: Setup RustOwl
        run: |
          cargo xtask toolchain cargo build --release
          cargo xtask toolchain cargo install --path crates/rustowl
      - name: Run Tests
        run: cargo xtask nvim-tests
  style:
    name: Check Styling Using Stylua
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Run Stylua
        uses: JohnnyMorganz/stylua-action@479972f01e665acfcba96ada452c36608bdbbb5e # v4.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: latest
          args: --check .
  lint:
    name: Lint Code Using Selene
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Lint Lua code with Selene
        uses: YoloWingPixie/selene-lua-linter-action@24ecf180fd5bb4d3b40b4296de61b32179cb79d1 # v1
        with:
          config-path: "selene.toml"
          working-directory: "."
          report-as-annotations: "true"
