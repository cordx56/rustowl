name: Security & Memory Safety
on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
permissions:
  contents: read
env:
  CARGO_TERM_COLOR: always
  RUSTC_BOOTSTRAP: 1
jobs:
  security-checks:
    name: Security & Memory Safety Analysis
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, ubuntu-24.04-arm]
        include:
          - os: ubuntu-latest
            runner_os: Linux
          - os: ubuntu-24.04-arm
            runner_os: Linux
          - os: macos-latest
            runner_os: macOS
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Install Rust toolchain
        uses: ./.github/actions/rust-toolchain-yq
        with:
          targets: ${{ matrix.target }}
          components: miri,rust-src,llvm-tools-preview,rustc-dev
      - name: Run comprehensive security checks
        run: |
          # cargo-deny is run in checks.yml; keep security.yml focused.
          cargo xtask security --no-deny
      - name: Create security summary and cleanup
        if: failure()
        shell: bash
        run: |
          # Only create summary and cleanup on failure
          echo "Security tests failed, creating summary..."

          # The security command should have created its own summary.
          if compgen -G "security-logs/security_summary_*.md" > /dev/null; then
            echo "Security summary found:"
            ls -la security-logs/security_summary_*.md
            echo "::error::Security test failures detected. Check the summary for details."
          else
            echo "Warning: security summary not found, creating fallback summary"
            mkdir -p security-logs
            echo "# Security Testing Summary (Failure)" > security-logs/failure-summary.txt
            echo "Generated: $(date)" >> security-logs/failure-summary.txt
            echo "OS: ${{ matrix.os }}" >> security-logs/failure-summary.txt
            echo "Status: Security tests failed" >> security-logs/failure-summary.txt
            echo "::error::Security tests failed and no detailed summary was found"
          fi

          # List all generated logs for debugging
          if [ -d "security-logs" ]; then
            echo "Available security logs:"
            ls -la security-logs/
            echo "Total log directory size: $(du -sh security-logs 2>/dev/null | cut -f1 || echo 'N/A')"
          fi
      - name: Cleanup build artifacts (on success)
        if: success()
        shell: bash
        run: |
          echo "Security tests passed! Cleaning up build artifacts..."
          # Remove security logs on success to save space
          if [ -d "security-logs" ]; then
            echo "Removing security logs (tests passed)"
            rm -rf security-logs/
          fi
      - name: Upload security artifacts (on failure only)
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: security-logs-${{ matrix.os }}-${{ github.run_id }}
          path: |
            security-logs/
            *.trace
            DrMemory-*.log
            drmemory.*.log
            instruments_output*.trace
          retention-days: 7
