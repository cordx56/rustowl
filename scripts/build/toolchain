#!/bin/sh -e

script_dir="$(cd $(dirname "$0"); pwd)"

IFS='
'
export $(/bin/sh "$script_dir/print-env.sh" "$(cat "${script_dir}/channel")")
unset IFS

DIST_BASE="https://static.rust-lang.org/dist"
download_component() {
    component="$1"
    url="${DIST_BASE}/${component}-${RUSTOWL_TOOLCHAIN}.${2:-"tar.gz"}"

    curl -fsSL "$url"
}

# install_toolchain <sysroot-path>
install_component() {
    temp="$(mktemp -d)"
    download_component "$1" | tar xzf - -C "$temp" > /dev/null
    echo "Component $1 extracted" 1>&2
    /bin/sh "$(find "$temp" -type f -name "install.sh" | head -n 1)" --destdir="$2" --prefix= > /dev/null
    rm -rf "$temp"
    echo "Component $1 installed." 1>&2
}
install_toolchain() {
    mkdir -p "$1"

    components="rustc rust-std cargo rustc-dev llvm-tools"
    for component in $components; do
        install_component "$component" "$1" &
    done
    wait
}

#
# main
#
if [ ! -d "${SYSROOT}" ]; then
    install_toolchain "${SYSROOT}"
fi

"$@"
