#!/bin/sh -e

script_dir="$(cd $(dirname "$0"); pwd)"

IFS='
'
export $(/bin/sh "$script_dir/print-env.sh" "$(cat "${script_dir}/channel")")
unset IFS

DIST_BASE="https://static.rust-lang.org/dist"
download_component() {
    url="${DIST_BASE}/$1-${RUSTOWL_TOOLCHAIN}.${2:-"tar.gz"}"
    echo "Downloading from $url" 1>&2

    curl -fsSL "$url"
}

# install_toolchain <sysroot-path>
install_component() {
    temp="$(mktemp -d)"
    download_component "$1" | tar xzf - -C "$temp" > /dev/null
    echo "Component $1 extracted" 1>&2

    component="$1-${RUSTOWL_TOOLCHAIN}"
    for com in $(cat "$temp/$component/components"); do
        base="$temp/$component/$com"
        (cd "$base" && find * -type f -exec /bin/sh -c "mkdir -p \"$2/\$(dirname \"{}\")\" && mv \"$base/{}\" \"$2/{}\"" \;)
    done

    rm -rf "$temp"
    echo "Component $1 installed." 1>&2
}
install_toolchain() {
    mkdir -p "$1"

    components="rustc rust-std cargo rustc-dev llvm-tools"
    for component in $components; do
        install_component "$component" "$1" &
    done
    wait
}

#
# main
#
if [ ! -d "${SYSROOT}" ]; then
    install_toolchain "${SYSROOT}"
fi

"$@"
